<!DOCTYPE html>
<meta charset="utf-8">
<style>
path {
    stroke-width: 2;
    fill: none;
}
.line {
    stroke: orange;
}
.axis path, .axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<body>
<script>
// 擷取時間
var parseTime = d3.timeParse("%H:%M");

// 手動加減時間
function addMinutes (target, minutes = 0) {
    // target 必須是 DateTime object
    target.setMinutes(target.getMinutes() + parseInt(minutes));
    return target;
}

// 設定車站資料
var mileage = {
    NAG:  -3.298,
    TPE:   5.904,
    BAC:  13.120,
    TAY:  42.285,
    HSC:  72.179,
    MIL: 104.865,
    TAC: 165.733,
    CHH: 193.886,
    YUL: 218.480,
    CHY: 251.585,
    TNN: 313.860,
    ZUY: 345.188,
}, intervals = {
    TPE: -3,
    BAC: -1,
    TAY: -1,
    HSC: -1,
    MIL: -1,
    TAC: -2,
    CHH: -1,
    YUL: -1,
    CHY: -1,
    TNN: -1,
};

// 設定範圍
var margin = {top: 30, right: 50, bottom: 30, left: 50},
    width = 1300 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

// 設定 SVG
var svg = d3.select("body")
    .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", "translate(" + margin.left + ", " + margin.top + ")");

// 設定 X 軸
var x = d3.scaleTime()
    // 座標範圍
    .range([0, width])
    // 資料範圍
    .domain([parseTime("06:30"), parseTime("09:00")]),
    xAxisBottom = d3.axisBottom(x).ticks(40),
    xAxisTop = d3.axisTop(x).ticks(40);

// 設定 Y 軸
var y = d3.scaleLinear()
    .range([0, height])
    .domain([mileage.NAG, mileage.ZUY]),
    yAxisLeft = d3.axisLeft(y).ticks(20),
    yAxisRight = d3.axisRight(y).ticks(20);

// 畫 X 軸
svg.append("g")
    .attr("class", "x axis bottom")
    .attr("transform", "translate(0, " + height + ")")
    .call(xAxisBottom);
svg.append("g")
    .attr("class", "x axis top")
    .call(xAxisTop);

// 畫 Y 軸
svg.append("g")
    .attr("class", "y axis left")
    .call(yAxisLeft);
svg.append("g")
    .attr("class", "y axis right")
    .attr("transform", "translate(" + width + ", 0)")
    .call(yAxisRight);

// d3.line
var valueline = d3.line()
    .x(function(d) { return x(d.time); })
    .y(function(d) { return y(d.mileage); });

// 讀取 CSV
d3.csv("https://raw.githubusercontent.com/repeat/taiwan-high-speed-rail-timetable/20170428/timetable.csv", function(d, i) {
    var train_no = d.車次,
        p = {
            NAG: parseTime(d.南港),
            TPE: parseTime(d.台北),
            BAC: parseTime(d.板橋),
            TAY: parseTime(d.桃園),
            HSC: parseTime(d.新竹),
            MIL: parseTime(d.苗栗),
            TAC: parseTime(d.台中),
            CHH: parseTime(d.彰化),
            YUL: parseTime(d.雲林),
            CHY: parseTime(d.嘉義),
            TNN: parseTime(d.台南),
            ZUY: parseTime(d.左營)
        },
        schedule = {};
        
    schedule[train_no] = [];
    
    switch (+train_no) {
        case 203:
            schedule[train_no].push(
                {mileage: mileage.TPE, time: p.TPE},
                {mileage: mileage.BAC, time: addMinutes(p.BAC, intervals.BAC)},
                {mileage: mileage.BAC, time: p.BAC},
                {mileage: mileage.TAC, time: addMinutes(p.TAC, intervals.TAC)},
                {mileage: mileage.TAC, time: p.TAC},
                {mileage: mileage.CHY, time: addMinutes(p.CHY, intervals.CHY)},
                {mileage: mileage.CHY, time: p.CHY},
                {mileage: mileage.TNN, time: addMinutes(p.TNN, intervals.TNN)},
                {mileage: mileage.TNN, time: p.TNN},
                {mileage: mileage.ZUY, time: p.ZUY}
            );
            schedule[train_no].columns = ["time", "mileage"];

            return schedule[train_no];
    } // endswitch +train_no
}, function (error, dataset) {
    // 畫折線
    dataset.forEach(function(data) {
        svg.append("path")
            .attr("class", "line")
            .attr("d", valueline(data));
    });
});
</script>
</body>
